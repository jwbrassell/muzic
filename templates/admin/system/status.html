{% extends "admin/base.html" %}

{% block title %}System Status - TapForNerd Radio Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">System Status</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshBtn">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- System Health -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card bg-success text-white">
            <div class="card-body">
                <div class="stats-icon bg-white text-success">
                    <i class="fas fa-server"></i>
                </div>
                <h3 class="card-title h2" id="systemUptime">-</h3>
                <p class="card-text">System Uptime</p>
                <div class="progress bg-white" style="height: 3px;">
                    <div class="progress-bar bg-white" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-info text-white">
            <div class="card-body">
                <div class="stats-icon bg-white text-info">
                    <i class="fas fa-microchip"></i>
                </div>
                <h3 class="card-title h2" id="cpuUsage">-</h3>
                <p class="card-text">CPU Usage</p>
                <div class="progress bg-white" style="height: 3px;">
                    <div class="progress-bar bg-white" id="cpuProgressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-warning text-white">
            <div class="card-body">
                <div class="stats-icon bg-white text-warning">
                    <i class="fas fa-memory"></i>
                </div>
                <h3 class="card-title h2" id="memoryUsage">-</h3>
                <p class="card-text">Memory Usage</p>
                <div class="progress bg-white" style="height: 3px;">
                    <div class="progress-bar bg-white" id="memoryProgressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-primary text-white">
            <div class="card-body">
                <div class="stats-icon bg-white text-primary">
                    <i class="fas fa-hdd"></i>
                </div>
                <h3 class="card-title h2" id="diskUsage">-</h3>
                <p class="card-text">Disk Usage</p>
                <div class="progress bg-white" style="height: 3px;">
                    <div class="progress-bar bg-white" id="diskProgressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Charts -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">CPU & Memory Usage Over Time</h5>
                <div class="chart-container">
                    <canvas id="resourcesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Network Traffic</h5>
                <div class="chart-container">
                    <canvas id="networkChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Services -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">System Services</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Uptime</th>
                                <th>Last Check</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="servicesList">
                            <tr>
                                <td colspan="5" class="text-center">Loading services...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Events -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Recent System Events</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Component</th>
                                <th>Message</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="eventsList">
                            <tr>
                                <td colspan="5" class="text-center">Loading events...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    const resourcesCtx = document.getElementById('resourcesChart').getContext('2d');
    const networkCtx = document.getElementById('networkChart').getContext('2d');
    
    const resourcesChart = new Chart(resourcesCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CPU Usage',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                },
                {
                    label: 'Memory Usage',
                    data: [],
                    borderColor: 'rgb(255, 159, 64)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    const networkChart = new Chart(networkCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Incoming',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    tension: 0.1
                },
                {
                    label: 'Outgoing',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Load system status
    function loadSystemStatus() {
        fetch('/api/v1/system/status')
            .then(response => response.json())
            .then(data => {
                // Update quick stats
                document.getElementById('systemUptime').textContent = formatUptime(data.uptime);
                document.getElementById('cpuUsage').textContent = `${data.cpu_usage}%`;
                document.getElementById('memoryUsage').textContent = `${data.memory_usage}%`;
                document.getElementById('diskUsage').textContent = `${data.disk_usage}%`;
                
                // Update progress bars
                document.getElementById('cpuProgressBar').style.width = `${data.cpu_usage}%`;
                document.getElementById('memoryProgressBar').style.width = `${data.memory_usage}%`;
                document.getElementById('diskProgressBar').style.width = `${data.disk_usage}%`;
                
                // Update charts
                const timestamps = data.history.map(h => h.timestamp);
                resourcesChart.data.labels = timestamps;
                resourcesChart.data.datasets[0].data = data.history.map(h => h.cpu_usage);
                resourcesChart.data.datasets[1].data = data.history.map(h => h.memory_usage);
                resourcesChart.update();
                
                networkChart.data.labels = timestamps;
                networkChart.data.datasets[0].data = data.history.map(h => h.network_in);
                networkChart.data.datasets[1].data = data.history.map(h => h.network_out);
                networkChart.update();
                
                // Update services list
                const servicesList = document.getElementById('servicesList');
                servicesList.innerHTML = data.services.map(service => `
                    <tr>
                        <td>
                            <i class="fas fa-${service.icon}"></i>
                            ${service.name}
                        </td>
                        <td>
                            <span class="badge bg-${getStatusColor(service.status)}">
                                ${service.status}
                            </span>
                        </td>
                        <td>${formatUptime(service.uptime)}</td>
                        <td>${formatDate(service.last_check)}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="restartService('${service.id}')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-${service.status === 'running' ? 'warning' : 'success'}" 
                                        onclick="toggleService('${service.id}')">
                                    <i class="fas fa-${service.status === 'running' ? 'stop' : 'play'}"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                // Update events list
                const eventsList = document.getElementById('eventsList');
                eventsList.innerHTML = data.events.map(event => `
                    <tr>
                        <td>${formatDate(event.timestamp)}</td>
                        <td>
                            <span class="badge bg-${getEventTypeColor(event.type)}">
                                ${event.type}
                            </span>
                        </td>
                        <td>${event.component}</td>
                        <td>${event.message}</td>
                        <td>
                            <span class="badge bg-${getStatusColor(event.status)}">
                                ${event.status}
                            </span>
                        </td>
                    </tr>
                `).join('');
            })
            .catch(error => {
                console.error('Error loading system status:', error);
                alert('Failed to load system status');
            });
    }
    
    // Format helpers
    function formatUptime(seconds) {
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        
        if (days > 0) return `${days}d ${hours}h`;
        if (hours > 0) return `${hours}h ${minutes}m`;
        return `${minutes}m`;
    }
    
    function formatDate(dateString) {
        return new Date(dateString).toLocaleString();
    }
    
    function getStatusColor(status) {
        switch (status.toLowerCase()) {
            case 'running':
            case 'healthy':
            case 'ok':
                return 'success';
            case 'warning':
            case 'degraded':
                return 'warning';
            case 'error':
            case 'stopped':
                return 'danger';
            default:
                return 'secondary';
        }
    }
    
    function getEventTypeColor(type) {
        switch (type.toLowerCase()) {
            case 'info': return 'info';
            case 'warning': return 'warning';
            case 'error': return 'danger';
            default: return 'secondary';
        }
    }
    
    // Service actions
    window.restartService = async function(serviceId) {
        if (!confirm('Are you sure you want to restart this service?')) return;
        
        try {
            const response = await fetch(`/api/v1/system/services/${serviceId}/restart`, {
                method: 'POST'
            });
            
            if (!response.ok) throw new Error('Failed to restart service');
            
            loadSystemStatus();
            
        } catch (error) {
            console.error('Error restarting service:', error);
            alert('Failed to restart service');
        }
    };
    
    window.toggleService = async function(serviceId) {
        try {
            const response = await fetch(`/api/v1/system/services/${serviceId}/toggle`, {
                method: 'POST'
            });
            
            if (!response.ok) throw new Error('Failed to toggle service');
            
            loadSystemStatus();
            
        } catch (error) {
            console.error('Error toggling service:', error);
            alert('Failed to toggle service');
        }
    };
    
    // Auto-refresh
    let refreshInterval = setInterval(loadSystemStatus, 30000); // Refresh every 30 seconds
    
    // Event handlers
    document.getElementById('refreshBtn').addEventListener('click', loadSystemStatus);
    
    // Initial load
    loadSystemStatus();
});
</script>
{% endblock %}
